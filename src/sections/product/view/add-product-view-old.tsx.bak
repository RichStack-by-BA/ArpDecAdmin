import type { RootState, AppDispatch } from 'src/store';

import { useState } from 'react';
import { useForm, Controller, useFieldArray } from 'react-hook-form';
import { yupResolver } from '@hookform/resolvers/yup';

import { useDispatch, useSelector } from 'react-redux';

import { useRouter } from 'src/routes/hooks';

import { addProductSchema } from 'src/validations';
import type { AddProductFormData } from 'src/validations';
import { DashboardContent } from 'src/layouts/dashboard';
import { addProduct } from 'src/store/slices/productSlice';
import { Iconify } from 'src/components/iconify';
import {
  BaseBox,
  BaseCard,
  BaseGrid,
  BaseChip,
  BaseAlert,
  BaseButton,
  BaseSwitch,
  BaseSelect,
  BaseMenuItem,
  BaseTextField,
  BaseTypography,
  BaseIconButton,
  BaseInputLabel,
  BaseFormControl,
  BaseCircularProgress,
  BaseFormControlLabel,
  BaseRichTextEditor,
} from 'src/components/baseComponents';

// ----------------------------------------------------------------------

export function AddProductView() {
  const router = useRouter();
  const dispatch = useDispatch<AppDispatch>();
  const { categories } = useSelector((state: RootState) => state.category);
  const { loading } = useSelector((state: RootState) => state.product);

  const [error, setError] = useState('');
  const [success, setSuccess] = useState('');
  const [images, setImages] = useState<File[]>([]);

  const {
    control,
    handleSubmit,
    formState: { errors, isValid },
    setValue,
    watch,
  } = useForm<AddProductFormData>({
    resolver: yupResolver(addProductSchema),
    mode: 'onChange',
    defaultValues: {
      name: '',
      selectedCategories: [],
      price: 0,
      discountPrice: 0,
      thumbnail: '',
      shortDescription: '',
      description: '',
      images: [],
      colors: [''],
      specifications: [{ key: '', value: '' }],
      policies: {
        returnPolicy: '',
        warranty: '',
        deliveryInfo: '',
      },
      isActive: true,
    },
  });

  const {
    fields: colorFields,
    append: appendColor,
    remove: removeColor,
  } = useFieldArray({
    control,
    name: 'colors',
  });

  const {
    fields: specFields,
    append: appendSpec,
    remove: removeSpec,
  } = useFieldArray({
    control,
    name: 'specifications',
  });

  const handleAddImage = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files) {
      const newImages = [...images, ...Array.from(e.target.files)];
      setImages(newImages);
      setValue('images', newImages as any, { shouldValidate: true });
    }
  };

  const handleRemoveImage = (index: number) => {
    const newImages = images.filter((_, i) => i !== index);
    setImages(newImages);
    setValue('images', newImages as any, { shouldValidate: true });
  };

  const onSubmit = async (data: AddProductFormData) => {
    setError('');
    setSuccess('');

    try {
      // Note: In production, you would upload images to a server/cloud storage first
      // and get back URLs. For now, we'll use placeholder URLs.
      const imageUrls =
        images.length > 0 ? images.map((_, idx) => `placeholder-url-${idx}.jpg`) : [];

      const payload = {
        name: data.name,
        categories: data.selectedCategories,
        price: data.price,
        discountPrice: data.discountPrice || undefined,
        thumbnail: data.thumbnail || imageUrls[0] || '',
        shortDescription: data.shortDescription || '',
        description: data.description,
        images: imageUrls,
        colors: data.colors?.filter((c) => c.trim()) || [],
        specifications: data.specifications?.filter((s) => s.key && s.value) || [],
        policies: data.policies,
        isActive: data.isActive,
      };

      const result = await dispatch(addProduct(payload));

      if (addProduct.fulfilled.match(result)) {
        setSuccess('Product added successfully!');
        setTimeout(() => {
          router.push('/products');
        }, 1500);
      } else {
        setError(result.payload as string || 'Failed to add product');
      }
    } catch (err: any) {
      setError(err.message || 'An error occurred while adding the product');
    }
  };

  return (
    <DashboardContent>
      <BaseBox sx={{ display: 'flex', alignItems: 'center', mb: 3 }}>
        <BaseIconButton onClick={() => router.push('/products')} sx={{ mr: 1 }}>
          <Iconify icon="eva:arrow-ios-forward-fill" sx={{ transform: 'rotate(180deg)' }} />
        </BaseIconButton>
        <BaseTypography variant="h4">Add New Product</BaseTypography>
      </BaseBox>

      {error && (
        <BaseAlert severity="error" sx={{ mb: 3 }}>
          {error}
        </BaseAlert>
      )}

      {success && (
        <BaseAlert severity="success" sx={{ mb: 3 }}>
          {success}
        </BaseAlert>
      )}

      <BaseGrid container spacing={3}>
        {/* Basic Information */}
        <BaseGrid size={{ xs: 12, md: 8 }}>
          <BaseCard sx={{ p: 3, mb: 3 }}>
            <BaseTypography variant="h6" sx={{ mb: 3 }}>
              Basic Information
            </BaseTypography>

            <BaseBox sx={{ display: 'flex', flexDirection: 'column', gap: 3 }}>
              <BaseTextField
                fullWidth
                label="Product Name"
                required
                value={formData.name}
                onChange={(e) => handleInputChange('name', e.target.value)}
              />

              <BaseFormControl fullWidth required>
                <BaseInputLabel>Categories</BaseInputLabel>
                <BaseSelect
                  multiple
                  value={formData.selectedCategories}
                  onChange={(e) =>
                    handleInputChange('selectedCategories', e.target.value)
                  }
                  renderValue={(selected: unknown) => (
                    <BaseBox sx={{ display: 'flex', flexWrap: 'wrap', gap: 0.5 }}>
                      {(selected as string[]).map((value: string) => (
                        <BaseChip
                          key={value}
                          label={
                            categories.find((cat) => cat.id === value)?.name || value
                          }
                          size="small"
                        />
                      ))}
                    </BaseBox>
                  )}
                >
                  {categories.map((category) => (
                    <BaseMenuItem key={category.id} value={category.id}>
                      {category.name}
                    </BaseMenuItem>
                  ))}
                </BaseSelect>
              </BaseFormControl>

              <BaseGrid container spacing={2}>
                <BaseGrid size={{ xs: 12, sm: 6 }}>
                  <BaseTextField
                    fullWidth
                    label="Price"
                    type="number"
                    required
                    value={formData.price}
                    onChange={(e) => handleInputChange('price', e.target.value)}
                  />
                </BaseGrid>
                <BaseGrid size={{ xs: 12, sm: 6 }}>
                  <BaseTextField
                    fullWidth
                    label="Discount Price"
                    type="number"
                    value={formData.discountPrice}
                    onChange={(e) => handleInputChange('discountPrice', e.target.value)}
                  />
                </BaseGrid>
              </BaseGrid>

              <BaseTextField
                fullWidth
                label="Stock"
                type="number"
                value={formData.stock}
                onChange={(e) => handleInputChange('stock', e.target.value)}
              />

              <BaseTextField
                fullWidth
                label="Thumbnail URL"
                value={formData.thumbnail}
                onChange={(e) => handleInputChange('thumbnail', e.target.value)}
              />

              <BaseTextField
                fullWidth
                label="Short Description"
                multiline
                rows={2}
                value={formData.shortDescription}
                onChange={(e) => handleInputChange('shortDescription', e.target.value)}
              />

              <BaseBox>
                <BaseTypography variant="subtitle2" sx={{ mb: 1 }}>
                  Description *
                </BaseTypography>
                <BaseRichTextEditor
                  value={formData.description}
                  onChange={(value) => handleInputChange('description', value)}
                  placeholder="Enter detailed product description with rich formatting..."
                  helperText="Use the toolbar to format your text. Supports headings, bold, italic, lists, colors, and links."
                  height={250}
                />
              </BaseBox>
            </BaseBox>
          </BaseCard>

          {/* Images */}
          <BaseCard sx={{ p: 3, mb: 3 }}>
            <BaseBox sx={{ display: 'flex', justifyContent: 'space-between', mb: 2 }}>
              <BaseTypography variant="h6">Product Images</BaseTypography>
              <BaseButton
                size="small"
                component="label"
                startIcon={<Iconify icon="mingcute:add-line" />}
              >
                Upload Images
                <input
                  type="file"
                  hidden
                  multiple
                  accept="image/*"
                  onChange={handleAddImage}
                />
              </BaseButton>
            </BaseBox>
            <BaseBox sx={{ display: 'flex', flexWrap: 'wrap', gap: 2 }}>
              {images.map((image, index) => (
                <BaseBox
                  key={index}
                  sx={{
                    position: 'relative',
                    width: 120,
                    height: 120,
                    borderRadius: 1,
                    overflow: 'hidden',
                    border: '1px solid',
                    borderColor: 'divider',
                  }}
                >
                  <img
                    src={URL.createObjectURL(image)}
                    alt={`Preview ${index + 1}`}
                    style={{
                      width: '100%',
                      height: '100%',
                      objectFit: 'cover',
                    }}
                  />
                  <BaseIconButton
                    size="small"
                    color="error"
                    onClick={() => handleRemoveImage(index)}
                    sx={{
                      position: 'absolute',
                      top: 4,
                      right: 4,
                      bgcolor: 'background.paper',
                      '&:hover': { bgcolor: 'background.paper' },
                    }}
                  >
                    <Iconify icon="solar:trash-bin-trash-bold" width={16} />
                  </BaseIconButton>
                </BaseBox>
              ))}
              {images.length === 0 && (
                <BaseTypography variant="body2" color="text.secondary">
                  No images uploaded yet. Click "Upload Images" to add product images.
                </BaseTypography>
              )}
            </BaseBox>
          </BaseCard>

          {/* Colors */}
          <BaseCard sx={{ p: 3, mb: 3 }}>
            <BaseBox sx={{ display: 'flex', justifyContent: 'space-between', mb: 2 }}>
              <BaseTypography variant="h6">Color Options</BaseTypography>
              <BaseButton
                size="small"
                startIcon={<Iconify icon="mingcute:add-line" />}
                onClick={handleAddColor}
              >
                Add Color
              </BaseButton>
            </BaseBox>
            <BaseBox sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
              {colors.map((color, index) => (
                <BaseBox key={index} sx={{ display: 'flex', gap: 1 }}>
                  <BaseTextField
                    fullWidth
                    label={`Color URL ${index + 1}`}
                    value={color}
                    onChange={(e) => handleColorChange(index, e.target.value)}
                  />
                  {colors.length > 1 && (
                    <BaseIconButton
                      color="error"
                      onClick={() => handleRemoveColor(index)}
                    >
                      <Iconify icon="solar:trash-bin-trash-bold" />
                    </BaseIconButton>
                  )}
                </BaseBox>
              ))}
            </BaseBox>
          </BaseCard>

          {/* Specifications */}
          <BaseCard sx={{ p: 3, mb: 3 }}>
            <BaseBox sx={{ display: 'flex', justifyContent: 'space-between', mb: 2 }}>
              <BaseTypography variant="h6">Specifications</BaseTypography>
              <BaseButton
                size="small"
                startIcon={<Iconify icon="mingcute:add-line" />}
                onClick={handleAddSpecification}
              >
                Add Specification
              </BaseButton>
            </BaseBox>
            <BaseTypography variant="caption" color="text.secondary" sx={{ mb: 2, display: 'block' }}>
              Add product specifications as key-value pairs. This information will be displayed in a structured format.
            </BaseTypography>
            <BaseBox sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
              {specifications.map((spec, index) => (
                <BaseBox key={index} sx={{ display: 'flex', gap: 1 }}>
                  <BaseTextField
                    label="Key"
                    value={spec.key}
                    onChange={(e) =>
                      handleSpecificationChange(index, 'key', e.target.value)
                    }
                    sx={{ flex: 1 }}
                  />
                  <BaseTextField
                    label="Value"
                    value={spec.value}
                    onChange={(e) =>
                      handleSpecificationChange(index, 'value', e.target.value)
                    }
                    sx={{ flex: 1 }}
                  />
                  {specifications.length > 1 && (
                    <BaseIconButton
                      color="error"
                      onClick={() => handleRemoveSpecification(index)}
                    >
                      <Iconify icon="solar:trash-bin-trash-bold" />
                    </BaseIconButton>
                  )}
                </BaseBox>
              ))}
            </BaseBox>
          </BaseCard>

          {/* Policies */}
          <BaseCard sx={{ p: 3 }}>
            <BaseTypography variant="h6" sx={{ mb: 3 }}>
              Policies
            </BaseTypography>
            <BaseTypography variant="caption" color="text.secondary" sx={{ mb: 2, display: 'block' }}>
              Define product policies for returns, warranty, and delivery information.
            </BaseTypography>
            <BaseBox sx={{ display: 'flex', flexDirection: 'column', gap: 3 }}>
              <BaseBox>
                <BaseTypography variant="subtitle2" sx={{ mb: 1 }}>
                  Return Policy
                </BaseTypography>
                <BaseRichTextEditor
                  value={policies.returnPolicy}
                  onChange={(value) => handlePolicyChange('returnPolicy', value)}
                  placeholder="e.g., 10-day replacement policy from the date of delivery"
                  height={150}
                />
              </BaseBox>
              
              <BaseBox>
                <BaseTypography variant="subtitle2" sx={{ mb: 1 }}>
                  Warranty
                </BaseTypography>
                <BaseRichTextEditor
                  value={policies.warranty}
                  onChange={(value) => handlePolicyChange('warranty', value)}
                  placeholder="e.g., 1-year manufacturer warranty"
                  height={150}
                />
              </BaseBox>
              
              <BaseBox>
                <BaseTypography variant="subtitle2" sx={{ mb: 1 }}>
                  Delivery Info
                </BaseTypography>
                <BaseRichTextEditor
                  value={policies.deliveryInfo}
                  onChange={(value) => handlePolicyChange('deliveryInfo', value)}
                  placeholder="e.g., Delivery in 3-5 business days"
                  height={150}
                />
              </BaseBox>
            </BaseBox>
          </BaseCard>
        </BaseGrid>

        {/* Sidebar */}
        <BaseGrid size={{ xs: 12, md: 4 }}>
          <BaseCard sx={{ p: 3, position: 'sticky', top: 24 }}>
            <BaseTypography variant="h6" sx={{ mb: 3 }}>
              Publish
            </BaseTypography>

            <BaseFormControlLabel
              control={
                <BaseSwitch
                  checked={formData.isActive}
                  onChange={(e) => handleInputChange('isActive', e.target.checked)}
                />
              }
              label="Active Status"
              sx={{ mb: 3 }}
            />

            <BaseBox sx={{ display: 'flex', gap: 2 }}>
              <BaseButton
                fullWidth
                variant="outlined"
                onClick={() => router.push('/products')}
                disabled={loading}
              >
                Cancel
              </BaseButton>
              <BaseButton
                fullWidth
                variant="contained"
                onClick={handleSubmit}
                disabled={loading}
              >
                {loading ? <BaseCircularProgress size={24} /> : 'Add Product'}
              </BaseButton>
            </BaseBox>
          </BaseCard>
        </BaseGrid>
      </BaseGrid>
    </DashboardContent>
  );
}
